import random, string, json, base64
from IPython.display import display, HTML

def generate_flashcards(n=1000):
    """Generate n flashcards with language/topic/difficulty, 4 options, correct index, and explanation."""
    cards=[]
    langs  = ['Python','Java','JavaScript']
    topics = ['Basics','Data Structures','Algorithms']
    diffs  = ['Easy','Medium','Hard']
    for _ in range(n):
        lang  = random.choice(langs)
        topic = random.choice(topics)
        diff  = random.choice(diffs)
        qtype = random.choice(['arith','power','str_upper','str_len','list_sort'])
        if qtype == 'arith':
            a,b=random.randint(1,20), random.randint(1,20)
            op=random.choice(['+','-','*','//','%'])
            expr=f'{a} {op} {b}'
            question=f'What is the result of {expr}?'
            correct=eval(expr)
            wrongs=set()
            while len(wrongs)<3:
                cand=correct+random.randint(-10,10)
                if cand!=correct:
                    wrongs.add(cand)
            options=list(wrongs)
            idx=random.randint(0,3)
            options.insert(idx, correct)
            explanation=f'{expr} = {correct}'
        elif qtype == 'power':
            a,b=random.randint(2,10), random.randint(2,4)
            question=f'What is the result of {a} ** {b}?'
            correct=a**b
            wrongs=set()
            while len(wrongs)<3:
                cand=correct+random.randint(-20,20)
                if cand!=correct:
                    wrongs.add(cand)
            options=list(wrongs)
            idx=random.randint(0,3)
            options.insert(idx, correct)
            explanation=f'{a} to the power of {b} equals {correct}'
        elif qtype == 'str_upper':
            s=''.join(random.choice(string.ascii_lowercase) for _ in range(3))
            question=f"What is the output of '{s}'.upper()?"
            correct=s.upper()
            wrongs={correct[::-1], correct.lower(), correct.title()}
            wrongs.discard(correct)
            wrongs=list(wrongs)[:3]
            idx=random.randint(0,3)
            options=wrongs
            options.insert(idx, correct)
            explanation=f"upper() returns all uppercase: {correct}"
        elif qtype == 'str_len':
            s=''.join(random.choice(string.ascii_lowercase) for _ in range(random.randint(3,6)))
            question=f"What is the length of '{s}'?"
            correct=len(s)
            wrongs=set()
            while len(wrongs)<3:
                cand=correct+random.randint(-2,2)
                if cand>0 and cand!=correct:
                    wrongs.add(cand)
            options=list(wrongs)
            idx=random.randint(0,3)
            options.insert(idx, correct)
            explanation=f"The string '{s}' has {correct} characters."
        else:  # list_sort
            lst=random.sample(range(1,20),4)
            question=f"What is the sorted version of {lst}?"
            correct_list=sorted(lst)
            correct=str(correct_list)
            wrongs={str(lst), str(lst[::-1]), str(sorted(lst, reverse=True))}
            wrongs.discard(correct)
            wrongs=list(wrongs)[:3]
            idx=random.randint(0,3)
            options=wrongs
            options.insert(idx, correct)
            explanation=f"Sorted list: {correct}"
        cards.append({
            'question':question,
            'options':options,
            'correct':idx,
            'language':lang,
            'topic':topic,
            'difficulty':diff,
            'explanation':explanation
        })
    return cards

# Generate the dataset and encode it
cards_data = generate_flashcards(1000)
cards_b64  = base64.b64encode(json.dumps(cards_data).encode()).decode()

# Build HTML/JS; note we concatenate cards_b64 so Python doesn't interpret ${score}
html = """
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f0f0f0; }
#filterBar { padding:10px; text-align:center; }
#filterBar select { margin:0 5px; padding:5px; font-size:0.9em; }
.phone-frame {
  width:360px; height:640px; margin:20px auto; border:12px solid #000;
  border-radius:40px; box-shadow:0 10px 15px rgba(0,0,0,0.2); background:#fff;
  display:flex; flex-direction:column; overflow:hidden;
}
#scoreboard {
  background:#fff; padding:10px 0; text-align:center; font-weight:bold;
  border-bottom:1px solid #eee;
}
#cards {
  flex:1; overflow-y:auto; scroll-snap-type:y mandatory;
}
.card {
  scroll-snap-align:start; min-height:640px; display:flex; flex-direction:column;
  justify-content:flex-start; align-items:center; padding:30px 20px;
  border-bottom:1px solid #fff;
}
.card h2 { text-align:center; margin-bottom:20px; font-size:1.1em; line-height:1.3; }
.option {
  width:90%; padding:12px; margin:6px 0; border:none; border-radius:12px;
  font-size:1em; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1);
  background:#ffffffaa; transition:background 0.3s;
}
.option.correct { background:#d4edda !important; }
.option.wrong   { background:#f8d7da !important; }
.explanation { margin-top:10px; font-size:0.85em; font-style:italic; color:#555; display:none; width:90%; text-align:left; }
#leaderboardPanel {
  position:fixed; top:0; right:0; width:280px; height:100%; background:#fff;
  box-shadow:-4px 0 8px rgba(0,0,0,0.2); padding:20px; overflow-y:auto; display:none; z-index:5;
}
#leaderboardPanel h2 { margin-top:0; font-size:1.1em; }
</style>

<div id="filterBar">
  <label>Lang:
    <select id="langFilter"></select>
  </label>
  <label>Topic:
    <select id="topicFilter"></select>
  </label>
  <label>Diff:
    <select id="diffFilter"></select>
  </label>
</div>

<div class="phone-frame">
  <div id="scoreboard">Score: 0 / 0 | XP: 0 | Streak: 0</div>
  <div id="cards"></div>
</div>

<div id="leaderboardPanel">
  <h2>Leaderboard & Profile</h2>
  <div id="leaderboard"></div>
</div>

<script>
var cards = JSON.parse(atob('""" + cards_b64 + """'));
var filtered = cards.slice();
var score=0, XP=0, streak=0;

function randomPastel() {
  const h = Math.floor(Math.random()*360);
  return 'hsl(' + h + ', 60%, 93%)';
}

var userName = localStorage.getItem('quizUserName');
if (!userName) {
  userName = prompt('Enter your username:') || 'Anonymous';
  localStorage.setItem('quizUserName', userName);
}

function populateFilters() {
  var langs=['All'], topics=['All'], diffs=['All'];
  cards.forEach(c => {
    if (!langs.includes(c.language))   langs.push(c.language);
    if (!topics.includes(c.topic))     topics.push(c.topic);
    if (!diffs.includes(c.difficulty)) diffs.push(c.difficulty);
  });
  const lf=document.getElementById('langFilter');
  const tf=document.getElementById('topicFilter');
  const df=document.getElementById('diffFilter');
  [lf,tf,df].forEach(sel => sel.innerHTML='');
  langs.forEach(l => { const o=document.createElement('option'); o.value=l; o.textContent=l; lf.appendChild(o); });
  topics.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; tf.appendChild(o); });
  diffs.forEach(d => { const o=document.createElement('option'); o.value=d; o.textContent=d; df.appendChild(o); });
}

function applyFilters() {
  const lang  = document.getElementById('langFilter').value;
  const topic = document.getElementById('topicFilter').value;
  const diff  = document.getElementById('diffFilter').value;
  filtered = cards.filter(c =>
    (lang === 'All'  || c.language   === lang) &&
    (topic === 'All' || c.topic      === topic) &&
    (diff === 'All'  || c.difficulty === diff)
  );
  score=0; XP=0; streak=0;
  updateScoreboard();
  renderCards();
}

function renderCards() {
  const container=document.getElementById('cards');
  container.innerHTML='';
  filtered.forEach((c, idx) => {
    const card=document.createElement('div');
    card.className='card';
    card.style.background=randomPastel();
    const q=document.createElement('h2');
    q.textContent=(idx+1) + '. ' + c.question;
    card.appendChild(q);
    c.options.forEach((opt,i) => {
      const btn=document.createElement('button');
      btn.className='option';
      btn.textContent=opt;
      btn.onclick=function() {
        if (btn.classList.contains('correct') || btn.classList.contains('wrong')) return;
        const btns=card.querySelectorAll('.option');
        btns.forEach(b => b.disabled=true);
        const expl=card.querySelector('.explanation');
        expl.style.display='block';
        if (i === c.correct) {
          btn.classList.add('correct');
          score+=1; XP+=10; streak+=1;
          expl.textContent=c.explanation;
        } else {
          btn.classList.add('wrong');
          btns[c.correct].classList.add('correct');
          streak=0;
          expl.textContent='Correct: ' + c.options[c.correct] + '. ' + c.explanation;
        }
        updateScoreboard();
        recordResult();
      };
      card.appendChild(btn);
    });
    const expl=document.createElement('div');
    expl.className='explanation';
    card.appendChild(expl);
    container.appendChild(card);
  });
}

function updateScoreboard() {
  document.getElementById('scoreboard').textContent =
    'Score: ' + score + ' / ' + filtered.length + ' | XP: ' + XP + ' | Streak: ' + streak;
}

function recordResult() {
  var results=JSON.parse(localStorage.getItem('quizLeaderboard') || '[]');
  var entry=results.find(item => item.name===userName);
  if (entry) {
    if (XP > entry.xp) entry.xp = XP;
  } else {
    results.push({ name:userName, xp:XP });
  }
  localStorage.setItem('quizLeaderboard', JSON.stringify(results));
}

function updateLeaderboard() {
  var results=JSON.parse(localStorage.getItem('quizLeaderboard') || '[]');
  results.sort((a,b) => b.xp - a.xp);
  const lb=document.getElementById('leaderboard');
  lb.innerHTML='';
  results.forEach((it, idx) => {
    const row=document.createElement('div');
    row.textContent=(idx+1) + '. ' + it.name + ' - ' + it.xp + ' XP';
    lb.appendChild(row);
  });
}

function showLeaderboard() {
  updateLeaderboard();
  document.getElementById('leaderboardPanel').style.display='block';
}
function hideLeaderboard() {
  document.getElementById('leaderboardPanel').style.display='none';
}

var touchStartX=null;
document.body.addEventListener('touchstart', e => touchStartX=e.changedTouches[0].screenX, false);
document.body.addEventListener('touchend', e => {
  var endX=e.changedTouches[0].screenX;
  if (touchStartX - endX > 50) showLeaderboard();
  else if (endX - touchStartX > 50) hideLeaderboard();
}, false);

// Initialize
populateFilters();
document.getElementById('langFilter').addEventListener('change', applyFilters);
document.getElementById('topicFilter').addEventListener('change', applyFilters);
document.getElementById('diffFilter').addEventListener('change', applyFilters);
renderCards();
updateScoreboard();
</script>
"""

display(HTML(html))
